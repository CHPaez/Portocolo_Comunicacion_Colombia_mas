<script>
async function subirAFileIO(blob, nombre) {
  const formData = new FormData();
  formData.append("file", blob, nombre);

  const resp = await fetch("https://file.io/?expires=1w", {
    method: "POST",
    body: formData
  });

  const json = await resp.json();
  if (!json.success) throw new Error("Error subiendo archivo a File.io");

  return json.link; // link de descarga
}

async function generarPDF(datos) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 15;
  doc.setFontSize(14);
  doc.text("Solicitud de contratación - Colombia Más", 10, y);
  y += 10;

  doc.setFontSize(10);
  datos.forEach(([campo, valor]) => {
    doc.text(`${campo}: ${valor}`, 10, y);
    y += 7;
  });

  return doc.output("blob");
}

function generarExcel(datos) {
  const ws = XLSX.utils.aoa_to_sheet([["Campo", "Valor"], ...datos]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Solicitud");

  return new Blob(
    [XLSX.write(wb, { bookType: "xlsx", type: "array" })],
    { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }
  );
}

async function generarYEnviar() {
  const mensaje = document.getElementById("mensaje");
  mensaje.innerHTML = "Generando archivos…";

  // Obtener datos
  const datos = [
    ["Área solicitante", area.value],
    ["Jefe inmediato", jefe.value],
    ["Correo jefe", correoJefe.value],
    ["Cargo solicitado", cargo.value],
    ["Tipo de contrato", contrato.value],
    ["Fecha ingreso", fecha.value],
    ["Ciudad / Sede", sede.value],
    ["Jornada", jornada.value],
    ["Motivo", motivo.value],
    ["Perfil", perfil.value],
    ["Observaciones", obs.value]
  ];

  // Validación
  if (datos.some(d => !d[1])) {
    mensaje.innerHTML = "<span style='color:red'>Completa todos los campos</span>";
    return;
  }

  // Generar archivos
  const pdfBlob = await generarPDF(datos);
  const excelBlob = generarExcel(datos);

  mensaje.innerHTML = "Subiendo archivos…";

  // Subir archivos a File.io
  const linkPDF = await subirAFileIO(pdfBlob, "solicitud.pdf");
  const linkExcel = await subirAFileIO(excelBlob, "solicitud.xlsx");

  mensaje.innerHTML = "Enviando correo…";

  // enviar correo sin adjuntos (solo links)
  fetch("https://formsubmit.co/ajax/cepb@hotmail.es", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      asunto: "Nueva solicitud de contratación",
      mensaje: "Una nueva solicitud ha sido registrada.",
      link_pdf: linkPDF,
      link_excel: linkExcel
    })
  })
  .then(() => {
    mensaje.innerHTML = `
      <span style="color:green;font-weight:700">
        ¡Solicitud enviada!<br>
        PDF: <a href="${linkPDF}" target="_blank">Ver PDF</a><br>
        Excel: <a href="${linkExcel}" target="_blank">Ver Excel</a>
      </span>`;
  })
  .catch(() => {
    mensaje.innerHTML = "<span style='color:red'>Error enviando el correo</span>";
  });
}
</script>




