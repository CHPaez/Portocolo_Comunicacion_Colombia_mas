<script>
const GITHUB_USERNAME = "CHPaez";
const GITHUB_REPO = "Portocolo_Comunicacion_Colombia_mas";
const GITHUB_PAT = "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";

async function subirArchivoGitHub(nombreArchivo, contenidoBlob) {
  const url = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${nombreArchivo}`;

  const reader = new FileReader();

  return new Promise((resolve, reject) => {
    reader.onloadend = async () => {
      const base64 = reader.result.split(",")[1];

      const data = {
        message: `Subiendo archivo ${nombreArchivo}`,
        content: base64
      };

      try {
        const resp = await fetch(url, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${GITHUB_PAT}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data)
        });

        const json = await resp.json();

        if (json.content?.path) {
          resolve(`https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/main/${json.content.path}`);
        } else {
          reject("Error subiendo archivo");
        }

      } catch (err) {
        reject(err);
      }
    };

    reader.readAsDataURL(contenidoBlob);
  });
}

function generarNombreArchivo(extension) {
  const now = new Date();
  const fecha =
    now.getFullYear() + "-" +
    String(now.getMonth() + 1).padStart(2, "0") + "-" +
    String(now.getDate()).padStart(2, "0") + "_" +
    String(now.getHours()).padStart(2, "0") + "-" +
    String(now.getMinutes()).padStart(2, "0") + "-" +
    String(now.getSeconds()).padStart(2, "0");

  return `solicitud_${fecha}.${extension}`;
}

async function generarPDF(datos) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 15;
  doc.setFontSize(14);
  doc.text("Solicitud de contratación - Colombia Más", 10, y);
  y += 10;

  doc.setFontSize(10);

  datos.forEach(([campo, valor]) => {
    doc.text(`${campo}: ${valor}`, 10, y);
    y += 7;
  });

  return doc.output("blob");
}

function generarExcel(datos) {
  const ws = XLSX.utils.aoa_to_sheet([["Campo", "Valor"], ...datos]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Solicitud");
  return new Blob([XLSX.write(wb, { bookType: "xlsx", type: "array" })]);
}

async function generarYEnviar() {
  const mensaje = document.getElementById("mensaje");
  mensaje.innerHTML = "Generando archivos…";

  const area = document.getElementById("area").value;
  const jefe = document.getElementById("jefe").value;
  const correoJefe = document.getElementById("correoJefe").value;
  const cargo = document.getElementById("cargo").value;
  const contrato = document.getElementById("contrato").value;
  const fecha = document.getElementById("fecha").value;
  const sede = document.getElementById("sede").value;
  const jornada = document.getElementById("jornada").value;
  const motivo = document.getElementById("motivo").value;
  const perfil = document.getElementById("perfil").value;
  const obs = document.getElementById("obs").value;

  const datos = [
    ["Área solicitante", area],
    ["Jefe inmediato", jefe],
    ["Correo jefe", correoJefe],
    ["Cargo solicitado", cargo],
    ["Tipo de contrato", contrato],
    ["Fecha ingreso", fecha],
    ["Ciudad / Sede", sede],
    ["Jornada", jornada],
    ["Motivo", motivo],
    ["Perfil", perfil],
    ["Observaciones", obs]
  ];

  const pdfBlob = await generarPDF(datos);
  const excelBlob = generarExcel(datos);

  const nombrePDF = generarNombreArchivo("pdf");
  const nombreXLSX = generarNombreArchivo("xlsx");

  mensaje.innerHTML = "Subiendo archivos a GitHub…";

  try {
    const urlPDF = await subirArchivoGitHub(nombrePDF, pdfBlob);
    const urlExcel = await subirArchivoGitHub(nombreXLSX, excelBlob);

    mensaje.innerHTML = "Enviando correo…";

    // Enviar correo con links
    fetch("https://formsubmit.co/ajax/cepb@hotmail.es", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        asunto: "Nueva solicitud de contratación",
        mensaje: "Se generaron los archivos",
        link_pdf: urlPDF,
        link_excel: urlExcel
      })
    });

    mensaje.innerHTML = `<span style="color:green;font-weight:700">¡Solicitud enviada!<br>PDF: <a href="${urlPDF}" target="_blank">Ver</a><br>Excel: <a href="${urlExcel}" target="_blank">Ver</a></span>`;
  }
  catch (e) {
    console.error(e);
    mensaje.innerHTML = `<span style="color:red">Error subiendo los archivos</span>`;
  }
}
</script>


